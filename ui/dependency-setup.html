<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPod Classic Tool - Dependency Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .output-container {
            background-color: #1f2937;
            color: #e5e7eb;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 16px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #374151;
        }
        .output-line {
            margin: 4px 0;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 1em;
            display: block;
            visibility: visible;
            opacity: 1;
        }
        .output-success { color: #86efac; }
        .output-error { color: #f87171; }
        .output-warning { color: #fbbf24; }
        .output-info { color: #60a5fa; }
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-t-lg shadow-lg p-6 border-b border-gray-200">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-3xl font-bold text-gray-800">üì¶ Dependency Setup</h1>
                <div id="statusBadge" class="status-badge status-pending">
                    <span id="statusText">Waiting to start...</span>
                </div>
            </div>
            <p class="text-gray-600">Installing and verifying Node.js, Python, and Chromium</p>
        </div>

        <!-- Main Content -->
        <div class="bg-white shadow-lg p-6">
            <!-- Dependency Checks -->
            <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span id="nodeIcon" class="text-xl">‚è≥</span>
                        <div>
                            <div class="font-semibold text-gray-800">Node.js</div>
                            <div id="nodeVersion" class="text-sm text-gray-500">Checking...</div>
                        </div>
                    </div>
                    <span id="nodeBadge" class="status-badge status-pending">Pending</span>
                </div>

                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span id="npmIcon" class="text-xl">‚è≥</span>
                        <div>
                            <div class="font-semibold text-gray-800">npm</div>
                            <div id="npmVersion" class="text-sm text-gray-500">Checking...</div>
                        </div>
                    </div>
                    <span id="npmBadge" class="status-badge status-pending">Pending</span>
                </div>

                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span id="pythonIcon" class="text-xl">‚è≥</span>
                        <div>
                            <div class="font-semibold text-gray-800">Python</div>
                            <div id="pythonVersion" class="text-sm text-gray-500">Checking...</div>
                        </div>
                    </div>
                    <span id="pythonBadge" class="status-badge status-pending">Pending</span>
                </div>
            </div>

            <!-- Output Log -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Setup Output</h2>
                <div id="outputContainer" class="output-container">
                    <div class="output-line output-info">Initializing setup...</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-3 justify-end">
                <button id="closeBtn" class="px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    Close
                </button>
                <button id="runSetupBtn" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-lg hover:from-blue-600 hover:to-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" style="display: none;">
                    <span>‚ñ∂</span>
                    Run Setup
                </button>
                <button id="finishBtn" class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2" style="display: none;">
                    <span>‚úì</span>
                    Finish
                </button>
            </div>
        </div>

        <!-- Info Footer -->
        <div class="bg-blue-50 rounded-b-lg shadow-lg p-4 border-t border-blue-200 text-sm text-blue-800">
            <strong>‚ÑπÔ∏è Info:</strong> This will download and install Node.js, Python, and Chromium if they're missing. This may take 5-10 minutes.
        </div>
    </div>

    <script>
        // Log immediately to verify script is loaded
        console.log('[Dependency Setup] Script started - page loaded');
        
        // Use ipcRenderer from preload
        const runSetupBtn = document.getElementById('runSetupBtn');
        const closeBtn = document.getElementById('closeBtn');
        const outputContainer = document.getElementById('outputContainer');
        
        console.log('[Dependency Setup] Elements found:', {
            runSetupBtn: !!runSetupBtn,
            closeBtn: !!closeBtn,
            outputContainer: !!outputContainer
        });
        
        // Ensure ipcRenderer is available
        if (!window.ipcRenderer) {
            console.error('[Dependency Setup] ipcRenderer not available!');
            document.body.innerHTML = '<div style="padding: 20px; color: red;">Error: IPC communication failed. Please restart the application.</div>';
        } else {
            console.log('[Dependency Setup] ipcRenderer is available and ready');
        }

        function appendOutput(message, type = 'info') {
            console.log(`[appendOutput START] type=${type}, messageLength=${message ? message.length : 0}`);
            console.log(`[appendOutput] message preview: "${message ? message.substring(0, 100).replace(/\n/g, '\\n') : 'null'}"`);
            
            const line = document.createElement('div');
            line.className = `output-line output-${type}`;
            line.textContent = message;
            line.style.minHeight = '20px';
            line.style.wordWrap = 'break-word';
            line.style.whiteSpace = 'pre-wrap';
            
            console.log(`[appendOutput] Created div element with class: "${line.className}"`);
            console.log(`[appendOutput] Element.textContent set to message`);
            console.log(`[appendOutput] Element HTML: ${line.outerHTML.substring(0, 200)}`);
            
            if (!message || message.trim() === '') {
                line.innerHTML = '&nbsp;';
                console.log(`[appendOutput] Message was empty, set to nbsp`);
            }
            
            outputContainer.appendChild(line);
            console.log(`[appendOutput] Appended to container. Total children: ${outputContainer.children.length}`);
            
            outputContainer.scrollTop = outputContainer.scrollHeight;
            console.log(`[appendOutput] Scrolled to bottom. ScrollTop: ${outputContainer.scrollTop}, ScrollHeight: ${outputContainer.scrollHeight}`);
            console.log(`[appendOutput END]\n`);
        }

        function updateStatus(tool, status, version = '') {
            const icon = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'pending': '‚è≥'
            }[status] || '‚è≥';

            const badge = {
                'success': 'status-success',
                'error': 'status-error',
                'pending': 'status-pending'
            }[status] || 'status-pending';

            const badge_text = {
                'success': 'Installed',
                'error': 'Failed',
                'pending': 'Checking'
            }[status] || 'Checking';

            const iconEl = document.getElementById(`${tool}Icon`);
            const badgeEl = document.getElementById(`${tool}Badge`);
            const versionEl = document.getElementById(`${tool}Version`);
            
            if (iconEl) iconEl.textContent = icon;
            if (badgeEl) {
                badgeEl.textContent = badge_text;
                badgeEl.className = `status-badge ${badge}`;
            }
            if (version && versionEl) {
                versionEl.textContent = version;
            }
        }

        function updateMainStatus(status) {
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');

            const config = {
                'success': { text: '‚úÖ Complete', class: 'status-success' },
                'error': { text: '‚ùå Failed', class: 'status-error' },
                'running': { text: 'üîÑ Running Setup...', class: 'status-pending' }
            };

            if (config[status]) {
                statusBadge.textContent = config[status].text;
                statusBadge.className = `status-badge ${config[status].class}`;
            }
        }

        runSetupBtn.addEventListener('click', async () => {
            console.log('[Setup Button] Click handler fired');
            console.log(`[Setup Button] ipcRenderer available: ${!!window.ipcRenderer}`);
            runSetupBtn.disabled = true;
            outputContainer.innerHTML = '';
            updateMainStatus('running');
            
            appendOutput('Starting setup process...', 'info');
            appendOutput('', 'info');

            console.log('[Setup Button] Sending run-setup-bat message to main process...');
            if (window.ipcRenderer && typeof window.ipcRenderer.send === 'function') {
                window.ipcRenderer.send('run-setup-bat');
                console.log('[Setup Button] Message sent successfully to main process');
            } else {
                console.error('[Setup Button] ERROR: ipcRenderer.send not available!');
                appendOutput('ERROR: Failed to communicate with main process. ipcRenderer not available.', 'error');
            }
        });

        closeBtn.addEventListener('click', () => {
            ipcRenderer.send('close-dependency-window');
        });

        console.log('[SETUP SCRIPT] About to register IPC listeners...');
        
        // SIMPLIFIED: Direct IPC listener with inline DOM update
        window.ipcRenderer.on('setup-output', function() {
            const args = Array.from(arguments);
            console.log('[IPC DIRECT] Listener fired with', args.length, 'arguments');
            console.log('[IPC DIRECT] Raw args:', args);
            
            // Get message and type from arguments
            const message = args[0];
            const type = args[1] || 'info';
            
            console.log('[IPC DIRECT] Parsed - message type:', typeof message, 'length:', message ? message.length : 0);
            console.log('[IPC DIRECT] Parsed - type:', type);
            
            if (!outputContainer) {
                console.error('[IPC DIRECT] outputContainer not found!');
                return;
            }
            
            // Create and append directly
            const line = document.createElement('div');
            line.className = `output-line output-${type}`;
            line.textContent = message || '';
            line.style.minHeight = '20px';
            
            outputContainer.appendChild(line);
            outputContainer.scrollTop = outputContainer.scrollHeight;
            
            console.log('[IPC DIRECT] DOM updated successfully');
        });
        
        console.log('[SETUP SCRIPT] IPC listener registered');

        // Listen for status updates
        window.ipcRenderer.on('setup-status', function() {
            const args = Array.from(arguments);
            const tool = args[0];
            const status = args[1];
            const version = args[2];
            console.log(`[IPC setup-status] tool=${tool}, status=${status}, version=${version}`);
            updateStatus(tool, status, version);
        });

        // Listen for completion
        window.ipcRenderer.on('setup-complete', function() {
            const args = Array.from(arguments);
            const success = args[0];
            const message = args[1];
            console.log(`[IPC setup-complete] Listener fired!`);
            console.log(`[IPC setup-complete] success=${success}, message="${message}"`);
            console.log(`[IPC setup-complete] Calling updateMainStatus('${success ? 'success' : 'error'}')`);
            updateMainStatus(success ? 'success' : 'error');
            console.log(`[IPC setup-complete] Status updated`);
            appendOutput('', 'info');
            appendOutput(message, success ? 'success' : 'error');
            console.log(`[IPC setup-complete] Output appended`);
            
            // Hide Run Setup button
            runSetupBtn.style.display = 'none';
            console.log('[IPC setup-complete] Hid Run Setup button');
            
            // Show Finish button
            const finishBtn = document.getElementById('finishBtn');
            if (finishBtn) {
                finishBtn.style.display = 'inline-flex';
                finishBtn.onclick = () => {
                    console.log('[finishBtn] Clicked - closing dependency window');
                    window.ipcRenderer.send('close-dependency-window');
                };
                console.log('[IPC setup-complete] Showed Finish button');
            } else {
                console.error('[IPC setup-complete] Finish button not found!');
            }
        });

        // Initial load - check if setup is needed
        if (window.ipcRenderer) {
            console.log('[Dependency Setup] Page ready, setting up IPC listeners...');
            
            // Show Run Setup button initially
            runSetupBtn.style.display = 'inline-flex';
            console.log('[Dependency Setup] Run Setup button shown');
            
            // Log all listeners
            console.log('[Dependency Setup] Registering on("setup-output")');
            console.log('[Dependency Setup] Registering on("setup-status")');
            console.log('[Dependency Setup] Registering on("setup-complete")');
            
            // Send a test message to verify IPC works
            console.log('[Dependency Setup] Sending IPC test message...');
            window.ipcRenderer.send('test-ipc', 'Hello from dependency setup');
            
            console.log('[Dependency Setup] Page loaded, sending check-dependencies...');
            window.ipcRenderer.send('check-dependencies');
            console.log('[Dependency Setup] check-dependencies sent to main process');
        } else {
            console.error('[Dependency Setup] ipcRenderer not available at startup!');
        }
    </script>
</body>
</html>
