const fs = require('fs');
const puppeteer = require('puppeteer');

const NETSCAPE_HEADER = `# Netscape HTTP Cookie File\n# This file was generated by cookie_exporter.cjs\n`;
const cookiesFilePath = process.argv[3] || 'cookies.txt';

function toNetscapeCookies(cookies) {
  return (
    NETSCAPE_HEADER +
    cookies
      .map((cookie) => {
        const domain = cookie.domain.startsWith('.') ? cookie.domain : '.' + cookie.domain;
        const flag = cookie.domain.startsWith('.') ? 'TRUE' : 'FALSE';
        const secure = cookie.secure ? 'TRUE' : 'FALSE';
        const expiry = cookie.expires || Math.floor(Date.now() / 1000) + 1209600; // 2 weeks
        return [
          domain,
          flag,
          cookie.path,
          secure,
          expiry,
          cookie.name,
          cookie.value,
        ].join('\t');
      })
      .join('\n')
  );
}

async function runExporter() {
  console.log("üöÄ Launching Puppeteer to export cookies...");
  const browser = await puppeteer.launch({ 
    headless: true, // Set to false if you need to see the window
    args: ['--no-sandbox', '--disable-setuid-sandbox'] 
  });

  try {
    const page = await browser.newPage();
    // Navigate to YouTube to ensure cookies are initialized/accessible
    await page.goto('https://www.youtube.com', { waitUntil: 'networkidle2' });

    const cookies = await page.cookies();
    const netscapeContent = toNetscapeCookies(cookies);

    fs.writeFileSync(cookiesFilePath, netscapeContent);
    console.log(`‚úÖ Success: Cookies written to ${cookiesFilePath}`);
  } catch (error) {
    console.error(`‚ùå Error exporting cookies: ${error.message}`);
  } finally {
    await browser.close();
    process.exit(0);
  }
}

runExporter();