const fs = require('fs');
const puppeteer = require('puppeteer');
const { spawn } = require('child_process');

const NETSCAPE_HEADER = `# Netscape HTTP Cookie File\n# This file was generated by cookie_exporter.cjs\n`;
const cookiesFilePath = process.argv[3] || 'cookies.txt';

/**
 * Auto-installs Chromium if missing
 */
function ensureChromiumInstalled() {
  return new Promise((resolve) => {
    console.log('[Chromium] Attempting to install Chromium...');
    console.log('[Chromium] This may take 2-5 minutes on first install.');
    
    let installProcess = null;
    
    // Try multiple ways to invoke npm/npx
    const attempts = [
      // Attempt 1: Direct npx (may work with PATH set correctly)
      { cmd: 'npx', args: ['puppeteer', 'browsers', 'install', 'chrome'] },
      // Attempt 2: npm exec (newer npm alternative to npx)
      { cmd: 'npm', args: ['exec', 'puppeteer', 'browsers', 'install', 'chrome'] },
      // Attempt 3: node -e to use npm programmatically
      { cmd: 'node', args: ['-e', 'require("child_process").spawnSync("npm", ["exec", "puppeteer", "browsers", "install", "chrome"], {stdio: "inherit"})'] }
    ];
    
    let currentAttempt = 0;
    
    function tryInstall() {
      if (currentAttempt >= attempts.length) {
        console.error(`[Chromium] ‚ùå All installation attempts failed`);
        resolve(false);
        return;
      }
      
      const attempt = attempts[currentAttempt];
      currentAttempt++;
      console.log(`[Chromium] Attempt ${currentAttempt}: ${attempt.cmd} ${attempt.args.slice(0, 2).join(' ')}`);
      
      try {
        installProcess = spawn(attempt.cmd, attempt.args, {
          stdio: 'inherit',
          shell: true,
          env: { ...process.env }
        });

        installProcess.on('close', (code) => {
          if (code === 0) {
            console.log('[Chromium] ‚úÖ Installation completed successfully!');
            resolve(true);
          } else {
            console.warn(`[Chromium] Attempt ${currentAttempt} failed with code ${code}`);
            tryInstall(); // Try next approach
          }
        });

        installProcess.on('error', (err) => {
          console.warn(`[Chromium] Attempt ${currentAttempt} error: ${err.message}`);
          tryInstall(); // Try next approach
        });
      } catch (err) {
        console.warn(`[Chromium] Attempt ${currentAttempt} exception: ${err.message}`);
        tryInstall(); // Try next approach
      }
    }
    
    tryInstall();
  });
}

function toNetscapeCookies(cookies) {
  return (
    NETSCAPE_HEADER +
    cookies
      .map((cookie) => {
        const domain = cookie.domain.startsWith('.') ? cookie.domain : '.' + cookie.domain;
        const flag = cookie.domain.startsWith('.') ? 'TRUE' : 'FALSE';
        const secure = cookie.secure ? 'TRUE' : 'FALSE';
        const expiry = cookie.expires || Math.floor(Date.now() / 1000) + 1209600; // 2 weeks
        return [
          domain,
          flag,
          cookie.path,
          secure,
          expiry,
          cookie.name,
          cookie.value,
        ].join('\t');
      })
      .join('\n')
  );
}

async function runExporter() {
  console.log("üöÄ Launching Puppeteer to export cookies...");
  
  try {
    const browser = await puppeteer.launch({ 
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox'] 
    });

    try {
      const page = await browser.newPage();
      // Navigate to YouTube to ensure cookies are initialized/accessible
      await page.goto('https://www.youtube.com', { waitUntil: 'networkidle2' });

      const cookies = await page.cookies();
      const netscapeContent = toNetscapeCookies(cookies);

      fs.writeFileSync(cookiesFilePath, netscapeContent);
      console.log(`‚úÖ Success: Cookies written to ${cookiesFilePath}`);
    } finally {
      await browser.close();
    }
  } catch (error) {
    const errorMsg = error.message || error.toString();
    
    // Check if it's a Chrome not found error
    if (errorMsg.includes('Could not find Chrome') || errorMsg.includes('Could not find Chromium')) {
      console.error(`‚ùå Chrome/Chromium not found!`);
      console.log(`[Chromium] Auto-installing Chromium in background...`);
      
      // Install Chromium and retry
      const installSuccess = await ensureChromiumInstalled();
      if (installSuccess) {
        console.log('[Chromium] Retrying cookie export...');
        // Retry the function recursively
        await runExporter();
        return;
      } else {
        console.error(`‚ùå Failed to install Chromium. Please run manually:`);
        console.error(`   npx puppeteer browsers install chrome`);
      }
    } else {
      console.error(`‚ùå Error exporting cookies: ${errorMsg}`);
    }
  }
  
  process.exit(0);
}

runExporter();